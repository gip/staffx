---
kind: "Document"
hash: "sha256:f4912a741dcde8846aabf516b31555254d3279d1347938732de3cfe124cf8701"
title: "StaffX Data Model and SQL Behavior"
language: "en"
---

# StaffX Data Model and SQL Behavior

This document describes the effective relational model implemented by apps/api/db/migrations/001_init_full_schema.sql. It is the baseline required to rebuild the platform state model.

## Core identity and collaboration entities
- users: authenticated principals mapped from Auth0 subject identifiers.
- projects: workspace container with owner, visibility, and archive state.
- project_collaborators: editor and viewer grants for non-owners.
- project_roles: project-specific role catalog used for scoped ownership of work areas.
- project_member_roles: assignment table between users and project role names.

## OpenShip system entities
- systems: immutable snapshots of architecture state.
- concerns: concern registry per system.
- nodes: typed topology entities with parent containment and metadata.
- edges: directed runtime, dataflow, and dependency links.
- documents: shared content-addressed documents with kinds Document, Skill, Prompt.
- matrix_refs: concern matrix references from node and concern to document hash.
- artifacts: node-scoped generated artifacts of type Summary, Code, Docs.
- file_contents: global content store for code files addressed by hash.
- artifact_files: join table linking artifacts to stored files.

## Thread and action timeline entities
- threads: project-scoped collaborative sessions with seed system and lifecycle status.
- actions: ordered action stream in thread timeline.
- messages: per-action conversation records.
- changes: structured mutation audit attached to update actions.
- agent_runs: execution queue and completion state for assistant actions.
- staffx_events: append-only event store for polling and SSE.

## Enumerations and validation constraints
- node_kind, edge_type, doc_kind, ref_type, artifact_type, provider, doc_source_type are enforced database enums.
- collaborator_role and project_visibility enforce role and access domain constraints.
- action_type, message_role, change_operation, and staffx_event_type constrain workflow records.
- uq_agent_runs_thread_active enforces one running run per thread.
- idx_nodes_single_root enforces one root node per system.
- matrix_refs uses concern_hash in key composition to constrain high-cardinality concern values.

## SQL functions that shape behavior
- thread_current_system resolves effective current system for a thread.
- fork_system deep-copies a system snapshot for immutable evolution.
- begin_action forks current system and starts an action timeline record.
- commit_action_empty removes empty output snapshots when no meaningful mutation remains.
- create_thread and clone_thread manage project_thread_id sequencing and seed linkage.
- upsert_file_content stores hashed file payloads for artifact file mapping.
- close_thread and commit_thread finalize thread status.
- diff_thread and diff_artifact_files support review and comparison workflows.
- validate_system_root_node plus deferrable triggers enforce root invariants.

## Materialized and logical views
- matrix_view materializes document and skill refs grouped by node and concern.
- artifact_files_view joins artifact file references to stored content records.
- node_overview provides topology inventory counters.
- user_projects resolves effective project access roles per user.
- thread_timeline exposes action order and input-output system lineage.
- project_summary aggregates project-level KPIs.

## Rebuild dependencies
- The API expects PostgreSQL with pgcrypto extension enabled.
- The migration must execute fully before API startup.
- Auth and integrations depend on users and integration tables during first request bootstrap.
- OpenShip run completion depends on systems, nodes, concerns, documents, matrix_refs, artifacts, file_contents, and artifact_files integrity.
