---
kind: "Document"
hash: "sha256:c3d14eaf0a3806b8fe2c24e90f7873f24543cf5ac9347965fe9f3587e26decb8"
title: "API v1 Endpoint Contracts"
language: "en"
---

# API v1 Endpoint Contracts

This specification is exhaustive for active mounted routes in apps/api/src/index.ts, apps/api/src/routes/v1.ts, apps/api/src/routes/health.ts, apps/api/src/routes/me.ts, apps/api/src/routes/users.ts, and apps/api/src/routes/integrations.ts.
All v1 route handlers in apps/api/src/routes/v1.ts inherit bearer authentication through a preHandler hook. Routes from health, me, users, and integrations apply their own authentication policy as implemented.

## Identifier and pagination rules
- Thread route identifiers accept UUID and numeric project thread identifiers. Numeric identifiers can be ambiguous across projects and then require projectId query disambiguation.
- Paginated list routes use page and pageSize. Events use limit and cursor semantics.
- Problem response format follows RFC7807 style payload fields type, title, status, detail, and instance.

## Endpoint contracts

### GET /v1/health
- Authentication: No bearer token. Public health probe endpoint.
- Request contract: No path parameters, no query parameters, no request body.
- Response contract: 200 returns status ok and the database time value.
- Error contract: Operational failure returns 5xx from Fastify.
- Side effects: No persistent mutation.
- Data access: Reads database time via SELECT NOW.
- Event behavior: No events emitted.

### GET /v1/me
- Authentication: Bearer token required. Token is verified against Auth0 JWKS.
- Request contract: No path parameters, no query parameters, no body.
- Response contract: 200 returns authenticated user profile fields including id, handle, email, name, picture, orgId and scope.
- Error contract: 401 for missing or invalid token. 500 if user upsert fails.
- Side effects: Creates or updates users row on first authenticated access.
- Data access: Reads and writes users.
- Event behavior: No events emitted.

### GET /v1/users/search
- Authentication: Bearer token required.
- Request contract: Query parameter q is required and must be non-empty.
- Response contract: 200 returns up to 10 users with handle, name and picture.
- Error contract: 400 when q is missing or empty. 401 on auth failure.
- Side effects: No persistent mutation.
- Data access: Reads users.
- Event behavior: No events emitted.

### GET /v1/users/:handle
- Authentication: Optional bearer token. Anonymous access allowed for public visibility checks.
- Request contract: Path parameter handle is case-insensitive.
- Response contract: 200 returns user profile plus projects visible to the caller with role and visibility metadata.
- Error contract: 404 when target user does not exist.
- Side effects: No persistent mutation.
- Data access: Reads users, projects, user_projects view, project_collaborators.
- Event behavior: No events emitted.

### GET /v1/integrations/:provider/authorize
- Authentication: Bearer token required.
- Request contract: Path provider must be notion or google. Optional returnTo query.
- Response contract: 302 redirect to provider authorization URL.
- Error contract: 400 on invalid provider.
- Side effects: Creates integration_oauth_states row.
- Data access: Writes integration_oauth_states.
- Event behavior: No events emitted.

### GET /v1/integrations/:provider/authorize-url
- Authentication: Bearer token required.
- Request contract: Path provider must be notion or google. Optional returnTo query.
- Response contract: 200 returns object containing URL.
- Error contract: 400 on invalid provider.
- Side effects: Creates integration_oauth_states row.
- Data access: Writes integration_oauth_states.
- Event behavior: No events emitted.

### GET /v1/integrations/:provider/callback
- Authentication: No bearer token. OAuth callback uses state lookup.
- Request contract: Provider path plus required code and state query parameters.
- Response contract: 303 redirect back to sanitized returnTo with integration status query params.
- Error contract: 400 for invalid provider, missing code or state, unknown or expired state.
- Side effects: Exchanges OAuth code, upserts user_integrations, deletes integration_oauth_states entry.
- Data access: Reads and writes integration_oauth_states and user_integrations.
- Event behavior: No events emitted.

### GET /v1/integrations/:provider/status
- Authentication: Bearer token required.
- Request contract: Provider path notion or google.
- Response contract: 200 returns provider plus connected, disconnected, expired, or needs_reauth status.
- Error contract: 400 on invalid provider.
- Side effects: No persistent mutation.
- Data access: Reads user_integrations.
- Event behavior: No events emitted.

### POST /v1/integrations/:provider/disconnect
- Authentication: Bearer token required.
- Request contract: Provider path notion or google.
- Response contract: 200 returns provider status disconnected.
- Error contract: 400 on invalid provider.
- Side effects: Best effort token revocation and integration state update.
- Data access: Reads and updates user_integrations.
- Event behavior: No events emitted.

### GET /v1/projects
- Authentication: Bearer token required by v1 router preHandler.
- Request contract: Optional page, pageSize, and name query parameters.
- Response contract: 200 paginated projects list with accessRole, ownerHandle, threadCount, and latest thread previews.
- Error contract: 400 only when page or pageSize violate parsing constraints through utility fallback behavior.
- Side effects: No persistent mutation.
- Data access: Reads projects, users, project_collaborators, threads.
- Event behavior: No events emitted.

### POST /v1/projects
- Authentication: Bearer token required.
- Request contract: Body name required. Optional description and visibility.
- Response contract: 200 returns created project descriptor with owner role and initial thread count.
- Error contract: 400 invalid name or visibility. 409 duplicate project name per owner.
- Side effects: Transactional bootstrap of project, initial system, root node, and first thread.
- Data access: Writes projects, systems, nodes, threads through create_thread function.
- Event behavior: No events emitted in this handler.

### GET /v1/projects/check-name
- Authentication: Bearer token required.
- Request contract: Query parameter name required.
- Response contract: 200 returns available true or false.
- Error contract: 400 when name is missing.
- Side effects: No persistent mutation.
- Data access: Reads projects.
- Event behavior: No events emitted.

### GET /v1/projects/:handle/:projectName/collaborators
- Authentication: Bearer token required.
- Request contract: Owner handle and project name path parameters.
- Response contract: 200 returns accessRole, visibility, role catalog, concerns, and collaborators with projectRoles.
- Error contract: 404 when project not found or inaccessible.
- Side effects: No persistent mutation.
- Data access: Reads projects, users, project_collaborators, project_roles, project_member_roles, concerns, threads.
- Event behavior: No events emitted.

### PATCH /v1/projects/:handle/:projectName/description
- Authentication: Bearer token required. Owner or Editor role required.
- Request contract: Body field description required and may be string or null.
- Response contract: 200 returns normalized description value.
- Error contract: 400 invalid payload. 403 insufficient role. 404 project not found.
- Side effects: Updates project description.
- Data access: Updates projects.
- Event behavior: No events emitted.

### PATCH /v1/projects/:handle/:projectName/visibility
- Authentication: Bearer token required. Owner role required.
- Request contract: Body visibility must be public or private.
- Response contract: 200 returns updated visibility.
- Error contract: 400 invalid visibility. 403 insufficient role. 404 project missing.
- Side effects: Updates project visibility.
- Data access: Updates projects.
- Event behavior: No events emitted.

### POST /v1/projects/:handle/:projectName/archive
- Authentication: Bearer token required. Owner role required.
- Request contract: No body required.
- Response contract: 204 no content.
- Error contract: 403 owner required. 404 project missing.
- Side effects: Marks project as archived.
- Data access: Updates projects.is_archived.
- Event behavior: No events emitted.

### POST /v1/projects/:handle/:projectName/roles
- Authentication: Bearer token required. Owner role required.
- Request contract: Body name required for new project role.
- Response contract: 201 returns created role name and position.
- Error contract: 400 missing name. 403 owner required. 404 project missing. 409 duplicate role.
- Side effects: Creates project role record.
- Data access: Reads and writes project_roles.
- Event behavior: No events emitted.

### DELETE /v1/projects/:handle/:projectName/roles/:roleName
- Authentication: Bearer token required. Owner role required.
- Request contract: Role name path parameter.
- Response contract: 204 no content.
- Error contract: 403 owner required. 404 role not found. 409 role still assigned.
- Side effects: Deletes project role when unassigned.
- Data access: Reads project_member_roles and deletes project_roles.
- Event behavior: No events emitted.

### POST /v1/projects/:handle/:projectName/concerns
- Authentication: Bearer token required. Owner role required.
- Request contract: Body name required.
- Response contract: 201 returns concern object with position and baseline flag.
- Error contract: 400 missing name. 403 owner required. 404 project or system missing. 409 duplicate concern.
- Side effects: Creates concern row in current project system.
- Data access: Reads threads for current system and writes concerns.
- Event behavior: No events emitted.

### DELETE /v1/projects/:handle/:projectName/concerns/:concernName
- Authentication: Bearer token required. Owner role required.
- Request contract: Concern name path parameter.
- Response contract: 204 no content.
- Error contract: 403 owner required. 404 concern missing. 409 concern still referenced by matrix_refs or artifacts.
- Side effects: Deletes concern only when unreferenced.
- Data access: Reads and deletes concerns, reads matrix_refs and artifacts.
- Event behavior: No events emitted.

### POST /v1/projects/:handle/:projectName/collaborators
- Authentication: Bearer token required. Owner role required.
- Request contract: Body requires collaborator handle and non-empty projectRoles array. Optional role defaults to Editor.
- Response contract: 201 returns collaborator record with assigned roles.
- Error contract: 400 invalid payload or invalid role references. 403 owner required. 404 project or user missing. 409 duplicate collaborator.
- Side effects: Transactional insert into collaborator and project member role tables.
- Data access: Reads users and project_roles. Writes project_collaborators and project_member_roles.
- Event behavior: No events emitted.

### DELETE /v1/projects/:handle/:projectName/collaborators/:collaboratorHandle
- Authentication: Bearer token required. Owner role required.
- Request contract: Collaborator handle path parameter.
- Response contract: 204 no content.
- Error contract: 403 owner required. 404 user or collaborator missing.
- Side effects: Removes collaborator and all project member roles.
- Data access: Deletes from project_member_roles and project_collaborators.
- Event behavior: No events emitted.

### PUT /v1/projects/:handle/:projectName/collaborators/:collaboratorHandle/roles
- Authentication: Bearer token required. Owner role required.
- Request contract: Body projectRoles array required and validated against role catalog.
- Response contract: 200 returns assigned projectRoles.
- Error contract: 400 invalid role payload. 403 owner required. 404 member missing.
- Side effects: Transactional replacement of member role assignments.
- Data access: Reads users and project_roles. Deletes and inserts project_member_roles.
- Event behavior: No events emitted.

### GET /v1/integrations
- Authentication: Bearer token required.
- Request contract: No query or body.
- Response contract: 200 returns notion and google status list normalized for token expiration state.
- Error contract: Standard 401 for auth issues.
- Side effects: No persistent mutation.
- Data access: Reads user_integrations.
- Event behavior: No events emitted.

### GET /v1/threads
- Authentication: Bearer token required.
- Request contract: Optional projectId, page, pageSize query parameters.
- Response contract: 200 paginated thread summaries with accessRole and project metadata.
- Error contract: 400 on invalid pagination values through parser fallback behavior and policy controls.
- Side effects: No persistent mutation.
- Data access: Reads threads, projects, users, project_collaborators.
- Event behavior: No events emitted.

### POST /v1/threads
- Authentication: Bearer token required. Owner or Editor required on target project.
- Request contract: Body requires projectId and may include title, description, and sourceThreadId.
- Response contract: 200 returns created thread summary including projectThreadId.
- Error contract: 400 invalid projectId or sourceThreadId format, or no clone source available. 403 no edit rights.
- Side effects: Creates cloned thread using clone_thread function.
- Data access: Reads and writes threads; reads projects and project roles.
- Event behavior: Emits assistant.run.started event with action create payload.

### GET /v1/threads/:threadId
- Authentication: Bearer token required.
- Request contract: threadId accepts UUID or numeric project_thread_id. Optional projectId disambiguates numeric IDs.
- Response contract: 200 returns full thread detail payload including permissions, topology, matrix, system prompt fields, and chat history.
- Error contract: 400 invalid or ambiguous thread identifiers. 404 inaccessible thread.
- Side effects: No persistent mutation.
- Data access: Reads threads, projects, users, nodes, edges, matrix_refs, documents, concerns, messages, actions, agent_runs.
- Event behavior: No events emitted.

### PATCH /v1/threads/:threadId
- Authentication: Bearer token required. Owner or Editor required.
- Request contract: Body can include title, description, and status fields.
- Response contract: 200 returns updated thread fields.
- Error contract: 400 invalid payload or values. 403 no edit rights. 404 thread missing.
- Side effects: Updates thread row.
- Data access: Updates threads.
- Event behavior: No events emitted.

### DELETE /v1/threads/:threadId
- Authentication: Bearer token required. Owner or Editor required.
- Request contract: threadId with optional projectId disambiguation.
- Response contract: 204 no content.
- Error contract: 400 invalid identifiers. 403 no edit rights. 404 thread missing.
- Side effects: Deletes thread and dependent records through cascading constraints.
- Data access: Deletes from threads with cascades to actions, messages, changes and queued runs.
- Event behavior: No events emitted.

### GET /v1/threads/:threadId/matrix
- Authentication: Bearer token required.
- Request contract: threadId with optional projectId.
- Response contract: 200 returns current systemId, topology, matrix cells, concern registry and document catalog.
- Error contract: 400 invalid identifiers. 404 missing thread. 500 if current system cannot be resolved.
- Side effects: No persistent mutation.
- Data access: Reads systems through thread_current_system, nodes, edges, concerns, matrix_refs and documents.
- Event behavior: No events emitted.

### PATCH /v1/threads/:threadId/matrix
- Authentication: Bearer token required. Owner or Editor required.
- Request contract: Body accepts layout or nodes or positions arrays with nodeId, x, y.
- Response contract: 200 returns changed count, systemId, and updated matrix node and cell payload.
- Error contract: 400 invalid payload. 403 no edit rights. 404 when no nodes are updated.
- Side effects: Updates node metadata layout coordinates.
- Data access: Updates nodes metadata. Reads matrix_refs and nodes for response.
- Event behavior: Emits thread.matrix.changed event.

### GET /v1/threads/:threadId/openship/bundle
- Authentication: Bearer token required. Owner or Editor required.
- Request contract: threadId with optional projectId.
- Response contract: 200 returns threadId, systemId, generatedAt timestamp and full file bundle list.
- Error contract: 403 no edit rights. 500 when system is missing or bundle generation fails.
- Side effects: Creates and removes temporary workspace directory for bundle generation.
- Data access: Reads current system and all dependent OpenShip tables through generator queries.
- Event behavior: No events emitted.

### POST /v1/threads/:threadId/chat
- Authentication: Bearer token required. Owner or Editor required.
- Request contract: Body content required. Optional role defaults to User and must be User, Assistant, or System.
- Response contract: 200 returns inserted message payload with action metadata.
- Error contract: 400 invalid content or role. 403 no edit rights. 404 thread missing.
- Side effects: Creates action row of Chat type and message row.
- Data access: Writes actions and messages.
- Event behavior: No events emitted directly from this handler.

### POST /v1/threads/:threadId/assistants/:assistantType/runs
- Authentication: Bearer token required. Owner or Editor required.
- Request contract: assistantType must be direct or plan. Optional model, prompt, chatMessageId, wait, sourceThreadId.
- Response contract: 200 returns runId, queued status, mode and resolved threadId.
- Error contract: 400 invalid assistantType, model, or chatMessageId. 403 no edit rights.
- Side effects: Enqueues agent run with resolved prompt and resolved system prompt.
- Data access: Reads thread and messages. Writes agent_runs.
- Event behavior: Emits assistant.run.started and assistant.run.waiting_input events for queue state.

### GET /v1/assistant-runs/:runId
- Authentication: Bearer token required and caller must have thread access.
- Request contract: runId UUID path parameter.
- Response contract: 200 returns normalized run object with result metadata.
- Error contract: 400 invalid runId. 403 inaccessible run. 404 run missing.
- Side effects: No persistent mutation.
- Data access: Reads agent_runs and access-controlled thread/project tables.
- Event behavior: No events emitted.

### POST /v1/assistant-runs/:runId/claim
- Authentication: Bearer token required and caller must have thread access.
- Request contract: runId UUID path parameter. Optional runnerId body.
- Response contract: 200 returns claimed or current run state.
- Error contract: 400 invalid runId. 403 inaccessible run. 404 run missing. 409 run unavailable.
- Side effects: Transitions queued run to running for the requesting runner.
- Data access: Updates agent_runs.
- Event behavior: Emits assistant.run.progress for claim status.

### POST /v1/assistant-runs/:runId/complete
- Authentication: Bearer token required and caller must have thread access.
- Request contract: Body requires status success or failed and non-empty messages. Optional changes, error, runnerId, openShipBundleFiles.
- Response contract: 200 returns finalized run state and completion assistant message payload when generated.
- Error contract: 400 invalid payload. 403 inaccessible run. 404 run missing. 409 already finalized.
- Side effects: Finalizes run, persists completion action messages, optionally applies OpenShip bundle to a forked system, and records change actions.
- Data access: Updates agent_runs. Writes actions, messages, changes. Writes and rewires systems through applyOpenShipBundleToThreadSystem.
- Event behavior: Emits assistant.run.completed or assistant.run.failed and chat.session.finished. Emits thread.matrix.changed when bundle apply succeeds.

### POST /v1/assistant-runs/:runId/cancel
- Authentication: Bearer token required and caller must have thread access.
- Request contract: runId UUID path parameter.
- Response contract: 200 returns cancelled run state.
- Error contract: 400 invalid runId. 403 inaccessible run. 404 run missing. 409 already finalized.
- Side effects: Marks queued or running run as cancelled with failure status fields.
- Data access: Updates agent_runs.
- Event behavior: Emits assistant.run.cancelled and chat.session.finished.

### GET /v1/events
- Authentication: Bearer token required.
- Request contract: Optional since cursor or timestamp and limit query parameters.
- Response contract: 200 returns ordered event list with nextCursor and pagination envelope.
- Error contract: 400 invalid since cursor or timestamp.
- Side effects: No persistent mutation.
- Data access: Reads staffx_events through queryEvents helper.
- Event behavior: No new events emitted.

### GET /v1/events/stream
- Authentication: Bearer token required.
- Request contract: Optional since query. Optional Last-Event-ID header for resume.
- Response contract: SSE stream with retry directive, heartbeat comments, per-event id, event, and data lines.
- Error contract: 400 invalid cursor input before stream starts.
- Side effects: Maintains live loop and heartbeat interval until disconnect.
- Data access: Reads staffx_events repeatedly via queryEvents.
- Event behavior: No new events emitted.

## Active versus inactive route modules
- Active route composition is defined by apps/api/src/index.ts. It mounts healthRoutes, meRoutes, integrationsRoutes, v1Routes, and userRoutes under /v1.
- apps/api/src/routes/projects.ts and apps/api/src/routes/thread.ts define legacy handlers but are not mounted by the active bootstrap and are therefore out of active API contract scope.

## Rebuild traceability
- API process bootstrap: apps/api/src/index.ts
- Endpoint implementation: apps/api/src/routes/v1.ts and mounted companion route files.
- Authentication and user bootstrap: apps/api/src/auth.ts
- Event persistence and cursors: apps/api/src/events.ts
- Run queue and completion state machine: apps/api/src/agent-queue.ts
- OpenShip apply and validation pipeline: apps/api/src/openship-sync.ts
- OpenShip export pipeline: apps/api/src/agent-runner.ts
- Schema and SQL functions: apps/api/db/migrations/001_init_full_schema.sql
